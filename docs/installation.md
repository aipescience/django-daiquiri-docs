Installation
============

For demonstration, development or testing purposes, Daiquiri can be installed on Linux or macOS. If you, however, to set up a production enviroment, serving Daiquiri over a Network or the Internet, we strongly suggest that you use a recent Linux distribution, namely CentOS7, Debian 9, or Ubuntu 18.04 LTS.

The code is mainly written in Python and should work with a Python higher than 3.5.

A usual installation of Daiquiri contains of several parts:

1. A directory which holds all the settings and customisations, custom to your installation of Daiquiri. We will call this directory `app`, but you can use any name you see fit.
2. The actual `django-daiquiri` package, which is centrally maintained, is installed as a dependency in a virtual environement.
3. A database to store the content, which is generated by the users of your Daiquiri installation. Currently, we support PostgreSQL, MySQL, and SQLite.
4. A (bigger) database where the actual science data is stored. This can be MySQL or PostgreSQL.
5. A directory on your filesystem with different files to be served.

For testing and development, you can run Daiquiri using your regular user account. On a production system, a dedicated user account should be used. For this documantation we will use a user called `daiquiri` with the group `daiquiri` and the home directory `/srv/daiquiri`.

Do not use the `root` user to run Daiquiri! It is a bad idea anyway and several steps of the installation will not work. `sudo` is used in the installation when needing root-privileges to install packages.


Prerequisites
-------------

Although, most dependencies are installed from the Python Package Index, some dependecies need to be installed using the operation systems packages manager. Here we document the minimum prerequisites.

```
# Centos 7.3
yum install -y \
    epel-release \
    git \
    gcc gcc-c++ \
    libxml2-devel libxslt-devel \
    openssl-devel \
    python3-devel

# Debian or Ubuntu
apt-get install -y \
    git \
    build-essential \
    libxml2-dev libxslt-dev \
    zlib1g-dev \
    libssl-dev \
    python3-dev
```

Obtaining the app directory
---------------------------

The next step is to create the `app` directory by cloning the corresponding repository.

```bash
git clone https://github.com/aipescience/django-daiquiri-app app
```

Note that this is not the main `django-daiquiri` repository, only the configuration files. Inside this directory, you will find:

* a `config` directory, containing the main settings of your Daiquiri installation,
* a `manage.py` script, which is the main way to interact with your Daiquiri installation on the command line. Most of the following steps will use this script.

The `app` directory corresponds to a [project](https://docs.djangoproject.com/en/1.11/intro/tutorial01) in Django terms.


Install Python packages
-----------------------

After you have obtained the `app`, you need to install the `django-daiquiri` package and the other python dependencies.

Change to the `app` directory and create a [Virtual Environment](https://docs.python.org/3/tutorial/venv.html) (this is done as your user or the created `daiquiri` user, not as `root`):

```
cd app

python3 -m venv env
source env/bin/activate

pip install --upgrade pip setuptools wheel
```

After the virtual environment is activated, the `django-daiquiri` package can be installed using `pip`:

```bash
pip install django-daiquiri
```

The virtual environment encapsulates your Daiquiri installation from the rest of the system. This makes it possible to run several applications with different python dependencies on one machine and to install the dependencies without root permissions.

**Important:** The virtual enviroment needs to be activated, using `source env/bin/activate` everytime a new terminal is used. This can be automated using your `.bashrc`.


Setup the application
---------------------

The settings of a Daiquiri application are specified in two files:

* `config/settings/base.py` should be part of the app repository and holds the basic settings for this particular site.
* `config/settings/local.py` is excluded from the repository and should contain (possible secret information) about this machine. This file will be different on the development and the production system.

To set up the application, you need to create a new file `config/settings/local.py` in your cloned `app` directory. For the example user with the home `/srv/daiquiri`, this would now be `/srv/daiquiri/app/config/settings/local.py`.

You can use `config/settings/sample.local.py` as template, i.e.:

```bash
cp config/settings/sample.local.py config/settings/local.py
```

The different settings are explained in detail [later in the documentation](settings.md). For a minimal configuration, you need to set 


```python
DEBUG = True
```

to see verbose error messages and serve static files, and 

```python
SECRET_KEY = ''
```

to a long random string, which you will keep secret. Your database connection is configured using the `DATABASES` variable. For PostgreSQL, you need to uncomment and edit:

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': '',
        'USER': '',
        'PASSWORD': '',
        'HOST': '',
        'PORT': 5432
    },
    'data': {
        'ENGINE': 'django.db.backends.postgresql',
         'OPTIONS': {
            'options': '-c search_path=%s,public' % TAP_SCHEMA
        },
        'NAME': '',
        'USER': '',
        'PASSWORD': '',
        'HOST': '',
        'PORT': 5432
    }
}

ADAPTER_DATABASE = 'daiquiri.core.adapter.database.postgres.PostgreSQLAdapter'
ADAPTER_DOWNLOAD = 'daiquiri.core.adapter.download.pgdump.PgDumpAdapter'
```

For MySQL you need:

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': '',
        'USER': '',
        'PASSWORD': ''
        'HOST': '',
        'PORT': 3306
    },
    'data': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': TAP_SCHEMA,
        'USER': '',
        'PASSWORD': '',
        'HOST': '',
        'PORT': 3306
    }
}

ADAPTER_DATABASE = 'daiquiri.core.adapter.database.mysql.MySQLAdapter'
ADAPTER_DOWNLOAD = 'daiquiri.core.adapter.download.mysqldump.MysqldumpAdapter'
```

`NAME`, `USER`, `PASSWORD`, `HOST`, `PORT` are the connction parameters to the data base server. As mentioned earlier, Daiquiri uses two separate database connections, one for the web application (`default`) and one for the scientific data (`data`). These database can be on different machines and you can even use MySQL for one and PostgreSQL for the other.

After editing the settings, initialize the application using:

```bash
python manage.py migrate                  # initializes the web database
python manage.py migrate --database data  # initializes the sscientific database
python manage.py createsuperuser          # creates the admin user
python manage.py download_vendor_files    # dowloads front-end files from the CDN
```

After these steps, Daiquiri can be run using Django's intergrated development server:

```bash
python manage.py runserver
```

Then, Daiquiri is available on [http://127.0.0.1:8000](http://127.0.0.1:8000) in your (local) browser.


Test data
---------


